{% extends "blog/base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <!-- Post Details -->
    <h2>{{ post.title }}</h2>
    <p><small>By {{ post.author }} on {{ post.published_date|date:"F j, Y" }}</small></p>
    <div class="post-content">
        {{ post.content|linebreaks }}
    </div>

    {% if user == post.author %}
        <p>
            <a href="{% url 'update_post' pk=post.id %}">Edit Post</a> |
            <a href="{% url 'delete_post' pk=post.id %}">Delete Post</a>
        </p>
    {% endif %}

    <hr>

    <!-- Comments List -->
    <h3>Comments ({{ comments.count }})</h3>
    {% if comments %}
        <ul>
            {% for comment in comments %}
                <li>
                    <strong>{{ comment.author }}</strong> â€” {{ comment.created_at|date:"F j, Y, g:i a" }}<br>
                    {{ comment.content|linebreaks }}

                    {% if user == comment.author %}
                        <a href="{% url 'update_comment' pk=post.id comment_pk=comment.id %}">Edit</a> |
                        <a href="{% url 'delete_comment' pk=post.id comment_pk=comment.id %}">Delete</a>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No comments yet. Be the first to comment!</p>
    {% endif %}

    <hr>

    <!-- Comment Form Section -->
    {% if user.is_authenticated %}
        {% if editing_comment %}
            <h4>Edit Comment</h4>
            <form action="{% url 'update_comment' pk=post.id comment_pk=editing_comment.id %}" method="post">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="btn btn-primary">Update</button>
                <a href="{% url 'post_detail' pk=post.id %}" class="btn btn-secondary">Cancel</a>
            </form>
        {% elif deleting_comment %}
            <h4>Are you sure you want to delete this comment?</h4>
            <form action="{% url 'delete_comment' pk=post.id comment_pk=deleting_comment.id %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Yes, delete</button>
                <a href="{% url 'post_detail' pk=post.id %}" class="btn btn-secondary">Cancel</a>
            </form>
        {% else %}
            <h4>Leave a Comment</h4>
            <form action="{% url 'create_comment' pk=post.id %}" method="post">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        {% endif %}
    {% else %}
        <p><a href="{% url 'login' %}">Login</a> to leave a comment.</p>
    {% endif %}

    <a href="{% url 'posts' %}" class="btn btn-secondary mt-3">Back to Posts</a>
</div>
{% endblock %}
